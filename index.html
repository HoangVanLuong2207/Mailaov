<!DOCTYPE html>
<html lang="vi">

<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>L·ªçc M√£ X√°c Minh</title>
  <style>
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      padding: 20px;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      min-height: 100vh;
      margin: 0;
    }

    .container {
      max-width: 600px;
      margin: 0 auto;
      background: white;
      padding: 30px;
      border-radius: 10px;
      box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2);
    }

    h1 {
      color: #333;
      text-align: center;
      margin-bottom: 30px;
    }

    .input-group {
      margin-bottom: 20px;
    }

    label {
      display: block;
      margin-bottom: 8px;
      font-weight: bold;
      color: #555;
    }

    input {
      width: 100%;
      padding: 12px;
      font-size: 1em;
      border: 2px solid #ddd;
      border-radius: 5px;
      transition: border-color 0.3s;
    }

    input:focus {
      outline: none;
      border-color: #667eea;
    }

    .button-group {
      display: flex;
      gap: 10px;
      margin-top: 20px;
    }

    button {
      flex: 1;
      padding: 12px;
      font-size: 1em;
      border: none;
      border-radius: 5px;
      cursor: pointer;
      font-weight: bold;
      transition: all 0.3s;
    }

    .btn-primary {
      background: #667eea;
      color: white;
    }

    .btn-primary:hover:enabled {
      background: #5568d3;
      transform: translateY(-2px);
      box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
    }

    .btn-secondary {
      background: #f0f0f0;
      color: #333;
    }

    .btn-secondary:hover:enabled {
      background: #e0e0e0;
    }

    button:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      transform: none;
      box-shadow: none;
    }

    .result {
      margin-top: 30px;
      padding: 20px;
      border-radius: 5px;
      display: none;
      animation: slideUp 0.3s ease;
    }

    .result.show {
      display: block;
    }

    .result.success {
      background: #d4edda;
      border: 2px solid #28a745;
      color: #155724;
    }

    .result.error {
      background: #f8d7da;
      border: 2px solid #dc3545;
      color: #721c24;
    }

    .result.info {
      background: #d1ecf1;
      border: 2px solid #17a2b8;
      color: #0c5460;
    }

    .code-display {
      font-size: 2em;
      font-weight: bold;
      text-align: center;
      margin-top: 15px;
      font-family: 'Courier New', monospace;
      letter-spacing: 5px;
    }

    .log {
      background: #f5f5f5;
      border: 1px solid #ddd;
      padding: 15px;
      border-radius: 5px;
      margin-top: 20px;
      max-height: 300px;
      overflow-y: auto;
      font-family: monospace;
      font-size: 0.85em;
    }

    .log-item {
      margin-bottom: 5px;
      padding: 5px 0;
    }

    .log-info {
      color: #0066cc;
    }

    .log-success {
      color: #28a745;
      font-weight: bold;
    }

    .log-error {
      color: #dc3545;
      font-weight: bold;
    }

    .loading {
      display: inline-block;
      width: 20px;
      height: 20px;
      border: 3px solid #f3f3f3;
      border-top: 3px solid #667eea;
      border-radius: 50%;
      animation: spin 1s linear infinite;
      margin-right: 10px;
    }

    @keyframes spin {
      0% {
        transform: rotate(0deg);
      }

      100% {
        transform: rotate(360deg);
      }
    }

    @keyframes slideUp {
      from {
        opacity: 0;
        transform: translateY(20px);
      }

      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>

<body>

  <div class="container">
    <h1>üìß L·ªçc M√£ X√°c Minh API</h1>

    <div class="input-group">
      <label for="username">Nh·∫≠p Username:</label>
      <input type="text" id="username" value="regcsuc48" placeholder="VD: regcsuc48, regcsuc49">
    </div>

    <div class="button-group">
      <button class="btn-primary" onclick="fetchCode()">
        <span id="btn-text">L·∫•y M√£ X√°c Minh</span>
      </button>
      <button class="btn-secondary" onclick="clearResult()">Reset</button>
      <button class="btn-secondary" id="btn-copy" onclick="copyCode()" disabled>Copy m√£</button>
      <button class="btn-secondary" onclick="window.open('account_email_suffix.html','_blank')">Gh√©p
        user|pass|email</button>
    </div>

    <div id="result" class="result"></div>

    <div class="log" id="log"></div>
  </div>

  <script>
    // L∆∞u m√£ hi·ªán t·∫°i ƒë·ªÉ ki·ªÉm tra tr√πng l·∫∑p
    let currentCode = null;
    const MAX_RETRY = 3; // S·ªë l·∫ßn th·ª≠ t·ªëi ƒëa khi m√£ tr√πng

    function addLog(message, type = 'info') {
      const logDiv = document.getElementById('log');
      const timestamp = new Date().toLocaleTimeString();
      const item = document.createElement('div');
      item.className = `log-item log-${type}`;
      item.textContent = `[${timestamp}] ${message}`;
      logDiv.appendChild(item);
      logDiv.scrollTop = logDiv.scrollHeight;
    }

    function showResult(message, type = 'info', code = null) {
      const resultDiv = document.getElementById('result');
      const btnCopy = document.getElementById('btn-copy');

      resultDiv.className = `result show ${type}`;

      let html = `<div>${message}</div>`;
      if (code) {
        html += `<div class="code-display" id="code-display">${code}</div>`;
        btnCopy.disabled = false; // C√≥ m√£ th√¨ cho copy
      } else {
        btnCopy.disabled = true;  // Kh√¥ng c√≥ m√£ th√¨ t·∫Øt copy
      }
      resultDiv.innerHTML = html;
    }

    function clearResult() {
      document.getElementById('result').classList.remove('show');
      document.getElementById('log').innerHTML = '';
      document.getElementById('username').value = 'regcsuc48';
      document.getElementById('btn-text').textContent = 'L·∫•y M√£ X√°c Minh';
      document.getElementById('btn-copy').disabled = true;
    }

    async function copyCode() {
      const codeEl = document.getElementById('code-display');
      const btnCopy = document.getElementById('btn-copy');

      if (!codeEl) {
        addLog('Kh√¥ng c√≥ m√£ ƒë·ªÉ copy', 'error');
        return;
      }

      const code = codeEl.textContent.trim();
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(code);
        } else {
          // Fallback n·∫øu clipboard API kh√¥ng h·ªó tr·ª£
          const textarea = document.createElement('textarea');
          textarea.value = code;
          document.body.appendChild(textarea);
          textarea.select();
          document.execCommand('copy');
          document.body.removeChild(textarea);
        }
        addLog(`üìã ƒê√£ copy m√£: ${code}`, 'success');
        const originalText = btnCopy.textContent;
        btnCopy.textContent = 'ƒê√£ copy ‚úî';
        setTimeout(() => {
          btnCopy.textContent = originalText;
        }, 1500);
      } catch (err) {
        addLog('‚ùå Copy th·∫•t b·∫°i: ' + err.message, 'error');
      }
    }

    // H√†m t·ª± ƒë·ªông copy m√£ (kh√¥ng c·∫ßn element, truy·ªÅn code tr·ª±c ti·∫øp)
    async function autoCopyCode(code) {
      const btnCopy = document.getElementById('btn-copy');
      let copied = false;

      // Th·ª≠ Clipboard API tr∆∞·ªõc
      try {
        if (navigator.clipboard && navigator.clipboard.writeText) {
          await navigator.clipboard.writeText(code);
          copied = true;
        }
      } catch (err) {
        // Clipboard API th·∫•t b·∫°i, s·∫Ω d√πng fallback
      }

      // Fallback: d√πng execCommand (ho·∫°t ƒë·ªông khi kh√¥ng focus)
      if (!copied) {
        try {
          const textarea = document.createElement('textarea');
          textarea.value = code;
          textarea.style.position = 'fixed';
          textarea.style.left = '-9999px';
          document.body.appendChild(textarea);
          textarea.focus();
          textarea.select();
          copied = document.execCommand('copy');
          document.body.removeChild(textarea);
        } catch (err) {
          addLog('‚ö†Ô∏è T·ª± ƒë·ªông copy th·∫•t b·∫°i: ' + err.message, 'info');
          return;
        }
      }

      if (copied) {
        addLog(`üìã T·ª± ƒë·ªông copy m√£: ${code}`, 'success');
        btnCopy.textContent = 'ƒê√£ copy ‚úî';
        setTimeout(() => {
          btnCopy.textContent = 'Copy m√£';
        }, 1500);
      }
    }

    async function fetchCode(retryCount = 0) {
      const username = document.getElementById('username').value.trim();
      const btnText = document.getElementById('btn-text');
      const btn = document.querySelector('.btn-primary');
      const btnCopy = document.getElementById('btn-copy');
      const originalText = 'L·∫•y M√£ X√°c Minh';

      if (!username) {
        showResult('‚ùå Vui l√≤ng nh·∫≠p username!', 'error');
        return;
      }

      // Ch·ªâ reset giao di·ªán khi l·∫ßn ƒë·∫ßu g·ªçi (kh√¥ng ph·∫£i retry)
      if (retryCount === 0) {
        document.getElementById('result').classList.remove('show');
        btnCopy.disabled = true;
        addLog(`Username: ${username}`, 'info');
      }

      btnText.innerHTML = retryCount > 0
        ? `<span class="loading"></span>Retry l·∫ßn ${retryCount}...`
        : '<span class="loading"></span>ƒêang x·ª≠ l√Ω...';
      btn.disabled = true;

      const email = `${username}@batdongsanvgp.com`;
      const apiUrl = `/api/get-code?username=${encodeURIComponent(username)}`;

      try {
        addLog(`G·ªçi backend: ${apiUrl}${retryCount > 0 ? ` (retry ${retryCount})` : ''}`, 'info');

        const response = await fetch(apiUrl, {
          method: 'GET',
          headers: {
            'Accept': 'application/json'
          }
        });

        if (!response.ok) {
          throw new Error(`HTTP ${response.status}: ${response.statusText}`);
        }

        const result = await response.json();

        if (!result.ok) {
          throw new Error(result.error || 'Backend tr·∫£ v·ªÅ l·ªói');
        }

        const data = result.raw;
        addLog('‚úì API proxy tr·∫£ v·ªÅ d·ªØ li·ªáu', 'success');

        if (Array.isArray(data) && data[0] && data[0].body) {
          const body = data[0].body;
          addLog('‚úì T√¨m th·∫•y body', 'success');

          // L·ªçc m√£
          let code = null;
          let match;

          // C√°ch 1: <b>12345678</b>
          match = body.match(/<b[^>]*>(\d{8})<\/b>/);
          if (match) code = match[1];

          // C√°ch 2: **12345678**
          if (!code) {
            match = body.match(/\*\*(\d{8})\*\*/);
            if (match) code = match[1];
          }

          // C√°ch 3: B·∫•t k·ª≥ 8 ch·ªØ s·ªë
          if (!code) {
            match = body.match(/\b(\d{8})\b/);
            if (match) code = match[1];
          }

          if (code) {
            // Ki·ªÉm tra m√£ m·ªõi c√≥ tr√πng v·ªõi m√£ c≈© kh√¥ng
            if (currentCode !== null && code === currentCode && retryCount < MAX_RETRY) {
              addLog(`‚ö†Ô∏è M√£ "${code}" tr√πng v·ªõi m√£ hi·ªán t·∫°i, t·ª± ƒë·ªông l·∫•y l·∫°i...`, 'info');
              // ƒê·ª£i 1 gi√¢y r·ªìi retry
              await new Promise(resolve => setTimeout(resolve, 1000));
              return fetchCode(retryCount + 1);
            }

            // C·∫≠p nh·∫≠t m√£ hi·ªán t·∫°i
            currentCode = code;

            if (retryCount > 0) {
              addLog(`‚úì T√¨m th·∫•y m√£ m·ªõi: ${code} (sau ${retryCount} l·∫ßn retry)`, 'success');
            } else {
              addLog(`‚úì T√¨m th·∫•y m√£: ${code}`, 'success');
            }
            showResult(`‚úÖ M√£ x√°c minh cho ${email}`, 'success', code);
            // T·ª± ƒë·ªông copy m√£ v√†o clipboard
            await autoCopyCode(code);
          } else {
            addLog('‚ùå Kh√¥ng t√¨m th·∫•y m√£ 8 ch·ªØ s·ªë', 'error');
            showResult('‚ùå Kh√¥ng t√¨m th·∫•y m√£ x√°c minh trong email', 'error');
          }
        } else {
          throw new Error('C·∫•u tr√∫c d·ªØ li·ªáu kh√¥ng h·ª£p l·ªá (kh√¥ng c√≥ body)');
        }

      } catch (error) {
        addLog(`‚ùå L·ªói: ${error.message}`, 'error');
        showResult(`‚ùå L·ªói: ${error.message}`, 'error');
      } finally {
        btnText.textContent = originalText;
        btn.disabled = false;
      }
    }

    // Enter ƒë·ªÉ g·ªçi API
    document.getElementById('username').addEventListener('keypress', function (e) {
      if (e.key === 'Enter') fetchCode();
    });
  </script>

</body>

</html>